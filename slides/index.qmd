---
title: "PrÃ¡tica AvanÃ§ada de Data Science e Visualization"
author: "Insper 2022-33"
format: 
  revealjs:
    self-contained: true
    hash-type: number
    footer: "2022"
    logo: logo.png
    theme: [simple, custom.scss]
execute:
  freeze: true
---

## Sobre mim

```{r}
#| echo: false
#| warning: false
#| message: false
library(tidyverse)
library(dados)
```

Meu nome Ã© Julio. Eu gosto de MasterChef

![](masterchef.gif)

## Sobre mim

Eu nÃ£o gosto de

-   Captchas
-   tretas R vs python

![](captcha.jpg){.absolute left="25%" bottom="10%" width="50%"}

## Meu papel

Meu papel nessa disciplina serÃ¡ ajudar no aprendizado da parte tÃ©cnica -- cÃ³digos etc.

::: incremental
-   TambÃ©m posso dar pitacos nas apresentaÃ§Ãµes e salvÃ¡-los em situaÃ§Ãµes de desespero (atendimentos extras).
:::

## Lab 01

Nesse lab, nosso objetivo serÃ¡ construir soluÃ§Ãµes em **R** e **python** para problemas comuns de transformaÃ§Ã£o de dados.

::: incremental
-   Equipes de **3 pessoas**. ComeÃ§aremos com uma alocaÃ§Ã£o por afinidade. Dependendo dos resultados, realocamos.

-   Eu serei o Google. Na parte do R, verificarei se vocÃªs fizeram tudo certo. Na parte do python, vocÃªs vÃ£o me ensinar.

-   No final de cada exercÃ­cio, discutiremos aspectos teÃ³ricos sobre as ferramentas (se necessÃ¡rio).
:::

## PrÃªmios

-   As melhores resoluÃ§Ãµes receberÃ£o stickers. A quantidade de stickers depende da dificuldade do exercÃ­cio.

![](stickers.jpg){.absolute left="25%" bottom="10vh" width="50%"}

## Vamos lÃ¡!

![](cat.gif){.absolute left="25%" bottom="10vh" width="50%"}

## ExercÃ­cio 1 (transformaÃ§Ã£o) ğŸ›‘

::: panel-tabset
### Entrada

```{r}
#| echo: true
pinguins
```

### Tarefa

-   Selecionar especie, ilha, comprimento do bico
-   Filtrar valores vazios
-   Agrupar por espÃ©cie
-   Calcular mÃ©dia e mediana
-   Calcular a diferenÃ§a absoluta da mÃ©dia e mediana

### SaÃ­da R

```{r}
#| echo: false
res <- pinguins |> 
  select(especie, ilha, comprimento_bico) |> 
  filter(!is.na(comprimento_bico)) |> 
  # drop_na(comprimento_bico) |> 
  group_by(especie) |> 
  summarise(
    media = mean(comprimento_bico),
    mediana = median(comprimento_bico)
  ) |> 
  arrange(desc(mediana)) |> 
  mutate(diferenca = abs(media - mediana))
res
```

### SaÃ­da Python

```{python}
#| echo: false
#| eval: false

import pandas as pd

media = r.pinguins[['especie', 'comprimento_bico']].dropna().groupby('especie').mean().rename(columns = {"comprimento_bico" : "media"})

mediana = r.pinguins[['especie', 'comprimento_bico']].dropna().groupby('especie').median().rename(columns = {"comprimento_bico" : "mediana"})

tabela = pd.merge(media, mediana, on = ['especie'], how = 'left')

tabela['dif'] = abs(tabela['media'] - tabela['mediana'])

tabela.sort_values('dif', ascending = False)

pinguins = r.pinguins

pinguins['comprimento_bico2'] = pinguins['comprimento_bico']

tabela = pinguins[["especie", "comprimento_bico", "comprimento_bico2"]].dropna().groupby("especie").agg({"comprimento_bico":"mean", "comprimento_bico2":"median"}).reset_index().rename(columns = {"comprimento_bico":"media", "comprimento_bico2":"mediana"}).


tabela['dif'] = abs(tabela['media'] - tabela['mediana'])
tabela.sort_values('dif', ascending = False)
```
:::

## ExercÃ­cio 2 (pivotagem) ğŸ›‘ğŸ›‘

::: panel-tabset
### Entrada

```{r}
dados_oms
```

### Tarefa

-   empilhar as colunas "novos_fpp", jogando as outras "novos\_\*" fora
-   filtrar ano maior ou igual a 2008 e paÃ­ses do resultado
-   agrupar por paÃ­s e ano
-   somar a quantidade total de casos
-   jogar a coluna ano nas colunas

### SaÃ­da R

```{r}
res <- dados_oms |> 
  pivot_longer(starts_with("novos_fpp")) |> 
  select(-contains("novos")) |> 
  filter(
    ano >= 2008, 
    !is.na(value),
    pais %in% c("Estados Unidos", "Brasil", "Ãndia")
  ) |> 
  select(pais, ano, value) |>
  pivot_wider(
    names_from = ano, 
    values_from = value,
    values_fn = sum
  )
  
res
```

### SaÃ­da Python

```{python}
import pandas as pd
pd.set_option('display.max_columns', None)
r.res
```
:::

## ExercÃ­cio 3 (joins) ğŸ›‘ğŸ›‘ğŸ›‘ğŸ›‘

::: panel-tabset
### Entrada

::: {style="overflow:auto;height:450px"}
```{r}
#| echo: true
print(clima, n = 1)
print(aeroportos, n = 1)
print(companhias_aereas, n = 1)
print(avioes, n = 1)
print(voos, n = 1)
```
:::

### Tarefa

-   juntar voos, clima, companhias aÃ©reas e aviÃµes
-   retirar fabricante vazio e retirar origem "EWR"
-   agrupar por fabricante, nome e origem
-   obter quantidade de vÃ´os e temperatura mÃ©dia
-   ordenar pela quantidade
-   mostrar resultados com \> 5 mil observaÃ§Ãµes

### SaÃ­da R

```{r}
#| echo: false
res <- voos |> 
  left_join(
    clima,
    c("ano", "mes", "dia", "hora", "origem")
  ) |> 
  left_join(companhias_aereas, "companhia_aerea") |> 
  left_join(avioes, c("cauda" = "codigo_cauda")) |> 
  filter(!is.na(fabricante), origem != "EWR") |> 
  group_by(fabricante, nome, origem) |> 
  summarise(
    n = n(), 
    .groups = "drop",
    temperatura_media = mean(temperatura, na.rm = TRUE)
  ) |> 
  arrange(desc(n)) |> 
  filter(n > 5000)

res
```

### SaÃ­da Python

```{python}
#| echo: false
r.res
```
:::

## ExercÃ­cio 4 (feat eng) ğŸ›‘ğŸ›‘ğŸ›‘ğŸ›‘ğŸ›‘

::: panel-tabset
### Objetivo

-   Melhorar o poder preditivo do modelo sem mudar nada na parte da modelagem
-   Vamos mexer apenas nas preditoras

### Base de dados

```{r}
#| echo: true
voos_select <- voos |> 
  select(
    ano, mes, dia, hora,
    companhia_aerea, cauda,
    origem, destino,
    y = atraso_saida
  ) |> 
  drop_na(y)

voos_select
```

### FunÃ§Ã£o objetivo

```{r}
#| cache: true
#| echo: true
#| code-line-numbers: "|1-4|6-10|12-13|15-19"
set.seed(1)
split <- rsample::initial_split(voos_select, prop = .8)
treino <- rsample::training(split)
teste <- rsample::testing(split)

feat_eng <- function(dados) {
  # ...exercicio...
  dados |> 
    select(-cauda)
}

treino_eng <- feat_eng(treino)
teste_eng <- feat_eng(teste) # cuidado

modelo <- parsnip::rand_forest("regression", trees = 20) |>  
  parsnip::set_engine("ranger")
fitted <- parsnip::fit(modelo, y ~ ., data = treino_eng)
preds <- predict(fitted, new_data = teste_eng)
result_antes <- yardstick::rmse_vec(teste_eng$y, preds$.pred)
```

### Meta

Resultado antes:

```{r}
#| echo: false
#| cache: true
result_antes
```

Resultado depois:

```{r}
#| echo: false
#| cache: true
feat_eng <- function(dados) {
  dados |> 
    left_join(
      clima,
      c("ano", "mes", "dia", "hora", "origem")
    ) |> 
    left_join(companhias_aereas, "companhia_aerea") |> 
    left_join(avioes, c("cauda" = "codigo_cauda")) |> 
    select(
      -ano.x, -cauda, -data_hora, -ano.y,
      -velocidade, -velocidade_rajada,
      -tipo, -fabricante, -modelo, -tipo_motor
    ) |> 
    mutate(across(
      where(is.numeric),
      replace_na, 5
    ))
}

treino_eng <- feat_eng(treino)
teste_eng <- feat_eng(teste) # cuidado

modelo <- parsnip::rand_forest("regression", trees = 20) |>  
  parsnip::set_engine("ranger")
fitted <- parsnip::fit(modelo, y ~ ., data = treino_eng)
preds <- predict(fitted, new_data = teste_eng)
yardstick::rmse_vec(teste_eng$y, preds$.pred)
```
:::

# Lab 02 - ggplot2

## Lab 02

Nesse lab, nosso objetivo serÃ¡ construir soluÃ§Ãµes em ggplot2 para grÃ¡ficos estatÃ­sticos.

-   Os grupos sÃ£o os que montamos para o trabalho final.

-   As tarefas serÃ£o imitar um grÃ¡fico que eu montei para vocÃªs usando ggplot2. Eu mostrarei apenas a imagem. Posso dar dicas no meio do caminho.

-   O grupo que conseguir fazer o grÃ¡fico primeiro ganharÃ¡ **prÃªmios**.

-   Quem fizer versÃµes em python dos grÃ¡ficos para me ensinar ganharÃ¡ **prÃªmios**.

## Base olist

Utilizaremos a base de dados da **olist**, para que vocÃªs possam aproveitar os trabalhos nas atividades integradoras.

::: incremental
-   Teoricamente, vocÃªs jÃ¡ tÃªm uma base de dados arrumada em mÃ£os, por conta dos exercÃ­cios do curso de Design.

-   Para garantir que as visualizaÃ§Ãµes funcionam, no entanto, disponibilizei uma base que eu montei (pode conter erros) [no material dos labs](https://github.com/padsInsper/202233-padsv/raw/main/material.zip).

-   A base estÃ¡ tanto em `.parquet` (usar pacote [`{arrow}`](https://arrow.apache.org/docs/r/) quanto em `.rds`. Use a que for mais confortÃ¡vel.

-   Se quiser usar sua prÃ³pria base, sem problemas!
:::

---

#### ExercÃ­cio 01 ğŸª

::: panel-tabset

#### Resultado esperado

```{r}
#| fig-align: center
#| out-width: 90%
knitr::include_graphics("ex01.png")
```

#### Dicas

- Usar a coluna `types`

- Estudar a funÃ§Ã£o `theme()`

- As `geom_label()` ficam na metade da altura da barra.

:::

---

#### ExercÃ­cio 02 ğŸªğŸª

::: panel-tabset

#### Resultado esperado

```{r}
#| fig-align: center
#| out-width: 90%
knitr::include_graphics("ex02.png")
```

#### Dicas

- Usar `scale_x_date()`

- Estudar `scale_color_viridis_d()`

:::


---

#### ExercÃ­cio 03 ğŸªğŸªğŸª

::: panel-tabset

#### Resultado esperado

```{r}
#| fig-align: center
#| out-width: 90%
knitr::include_graphics("ex03.png")
```

#### Dicas

- Usar o pacote `{ggridges}`.

- Para pintar apenas uma categoria, crie uma coluna.

- Para anotaÃ§Ãµes no grÃ¡fico (como "Mediana"), use a funÃ§Ã£o `annotate()`.

- Para fazer os reais, use a funÃ§Ã£o `scales::scales_dollar_format()`.

:::

---

#### ExercÃ­cio 04 ğŸªğŸªğŸªğŸª

::: panel-tabset

#### Resultado esperado

```{r}
#| fig-align: center
#| out-width: 90%
knitr::include_graphics("ex04.png")
```

#### Dicas

- FaÃ§a uma amostra de 1000 observaÃ§Ãµes dos dados, com `set.seed(42)`

- Para obter o mapa, usar o pacote `{geobr}`

- Para plotar o mapa, usar a funÃ§Ã£o `geom_sf()`

- Estamos desenhando CURVAS

- Use facets

:::

